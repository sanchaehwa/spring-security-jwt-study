## JWT 인증 방식 시큐리티 동작 원리

### **1. 회원가입 흐름 (POST /join)**

1.	**클라이언트가 /join으로 POST 요청**을 보냄

2.	JoinController가 DTO를 받고→ JoinService에 전달

3.	JoinService는 UserEntity 객체를 생성

4.	UserEntity를 UserRepository를 통해 DB에 저장

5.	완료되면 적절한 응답 반환 

### **2. 로그인 흐름 (POST /login)**

1.	클라이언트가 /login으로 POST 요청

2.	UsernamePasswordAuthenticationFilter가 이 요청을 가로챔 → AuthenticationManager에게 인증위임 

3.	AuthenticationManager는 내부에 아이디와 비밀번호를 전달한 후에 내부적으로 검증을 한다. 

- 내부적으로 검증을 하는 방법
    
    DB 안에 User 정보를 꺼내옴  → UserDetailService 가 UserDetails 객체에 담아서 AuthenticationManger에서 검증을 하게 됨 
    
- 기존 Session 방식과 JWT 방식의 차이점
    - 만약에 로그인을 성공하게 된다면 기존의 Session 방식은 서버의 Session에 저장
    - JWT 방식은 Session에 저장하지않고 SuccessfulAuthentication 이라는 매서드를 통해서 **JWTUtil 에서 토큰을 만든 후 응답**
- Filter Manager UserDetailService를 거치는 일련의 과정은 기존의 Session 방식과 JWT 방식 동일

### 3. 경로 접근 (인가)

**1. 로그인**

- 사용자가 아이디/비밀번호 입력
- 서버는 AuthenticationManager로 검증
- 검증 성공 → **JWT 토큰 생성**
- JWT 토큰을 **HTTP 응답에 담아서 클라이언트에게 전달**

1. **. 클라이언트는 요청마다 헤더에 토큰 포함**
    - 클라이언트는 JWT를 저장해뒀다가 다음 요청 때마다 **헤더에 첨부**
    
    ```java
    GET /admin/dashboard
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI...
    ```
    
2. 서버 JWT 필터에서 인증 처리
    - 서버에는 JWTAuthenticationFilter가 동작
    - 요청 헤더에서 **JWT를 추출하고 유효성 검증**
    - 토큰이 유효하면: 해당 사용자의 정보로 Authentication 객체 생성
    - SecurityContextHolder에  **인증정보 등록**

 여기서 생기는 “세션 비슷한 상태”는 **일시적이고 요청 단위임**

**4. 요청 끝 → 세션/컨텍스트 소멸**

- 요청이 끝나면 SecurityContextHolder 초기화됨
- **서버는 사용자 상태를 기억하지 않음** → Stateless

**5. 다시 다른 요청 오면?**

- 또 JWT 헤더로 보내고
- 다시 인증 처리해서 SecurityContextHolder에 등록

✔️ **세션 방식**

“놀이공원 입장하고 팔찌 찼어. 계속 돌아다닐 수 있어.”

✔️ **JWT 방식**

“매번 입장할 때 표 보여주고 들어가. 들어가서 한 바퀴 돌고 나오면, 다시 입장할 땐 또 표 보여줘야 돼.”

## CSRF

### CSRF 공격이란 ?

사이트 간 요청 위조 (Cross Site Request Forgery) 웹 사이트 취약점 공격의 하나. 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위 (수정 삭제 등록 등) 특정 웹사이트에 요청하게 하는 공격

### CSRF 공격을 막는 방법

서버에서 요청에 대한 검증을 하는것. 서버에서 토큰을 발급 및. 검증하고 클라이언트에서는 발급받은 토큰을 요청 값에 포함시켜 보내는 방식으로 CSRF 공격을 막을 수 있다. 

Spring Security 의존성을 추가하면 이와 같은 방식을 제공하는 CSRF Filter가 자동 추가

### CSRF Filter

```java
//CSRF Token 객체 조회
tokenRepository.loadToken(request) // HttpSessionCsrfTokenRepository.CSRF_TOKEN
//CSRF Token 발급
tokenRepository.generateToken(request) //CSRF Token이 없는 경우 DefaultCsrfToken 생성자를 통해 CSRF Token 발급
//CSRFToken 값 조회
request.setAttribute(CsrfToken.class.getName(), csrfToken)
//CSRF (Get , Head, Trace, options) 를 제외한 모든 매서드에 대해 CsrfToken 검증
requireCsrfProtectionMatcher.matches(request)

```

